SELECT 
ROUND((SUM(TOTAL)),3) GIRO
FROM((SELECT TIPO_PRD, NULL AS TOTAL,SUM(CUSTO_TOTAL) CUSTO_T FROM(SELECT FTC.TIPO_PRD TIPO_PRD, FTC.DESCRICAO DESCRICAO, ECON.COD_PRD COD_PRD, SUM(ECON.QTD_CONSUMO) QTD_CONSUMO, US.CUSTO_MED CUSTO_MED, 
(SUM(ECON.QTD_CONSUMO) * US.CUSTO_MED) CUSTO_TOTAL FROM ESHISCON ECON INNER JOIN FAPRDCAD FA ON FA.CODIGO=ECON.COD_PRD INNER JOIN FATIPCAD FTC ON FTC.TIPO_PRD=FA.TIPO_PRD 
LEFT JOIN ESHISCUS US ON US.COD_PRD=ECON.COD_PRD WHERE US.ANO_MES = (
SELECT  
CASE WHEN('01/01/2017' = $COMPETENCE) THEN '201701'   WHEN('01/02/2017' = $COMPETENCE) THEN '201702'  WHEN('01/03/2017' = $COMPETENCE) THEN '201703'  WHEN('01/04/2017' = $COMPETENCE) THEN '201704'  WHEN('01/05/2017' = $COMPETENCE
) THEN '201705'  WHEN('01/06/2017' = $COMPETENCE) THEN '201706'  WHEN('01/07/2017' = $COMPETENCE) THEN '201707'  WHEN('01/08/2017' = $COMPETENCE) THEN '201708'  WHEN('01/09/2017' = $COMPETENCE) THEN '201709'  WHEN('01/10/2017' = $COMPETENCE) THEN '201710'  WHEN('01/11/2017' = $COMPETENCE) THEN '201711'  WHEN('01/12/2017' = $COMPETENCE) THEN '201712' END AS DATA_REF
FROM DUAL
) AND ECON.ANO_MES = (SELECT  
CASE WHEN('01/01/2017' = $COMPETENCE) THEN '201701'   WHEN('01/02/2017' = $COMPETENCE) THEN '201702'  WHEN('01/03/2017' = $COMPETENCE) THEN '201703'  WHEN('01/04/2017' = $COMPETENCE) THEN '201704'  WHEN('01/05/2017' = $COMPETENCE
) THEN '201705'  WHEN('01/06/2017' = $COMPETENCE) THEN '201706'  WHEN('01/07/2017' = $COMPETENCE) THEN '201707'  WHEN('01/08/2017' = $COMPETENCE) THEN '201708'  WHEN('01/09/2017' = $COMPETENCE) THEN '201709'  WHEN('01/10/2017' = $COMPETENCE) THEN '201710'  WHEN('01/11/2017' = $COMPETENCE) THEN '201711'  WHEN('01/12/2017' = $COMPETENCE) THEN '201712' END AS DATA_REF
FROM DUAL) AND FTC.TIPO_PRD NOT IN ('OPM')
GROUP BY ECON.COD_PRD, US.CUSTO_MED, FTC.TIPO_PRD, FTC.DESCRICAO)GROUP BY TIPO_PRD, DESCRICAO
UNION ALL SELECT TIPO_PRD, SUM(TOTAL) TOTAL, NULL AS CUSTO_T FROM(SELECT ECAD.COD_PRD COD_PRD, TIP.TIPO_PRD TIPO_PRD, TIP.DESCRICAO DESCRICAO, ECUS.CUSTO_MED CUSTO_MED,
(SUM(ECAD.EST_ATU_MES) - SUM(ECAD.ENT_EST_CONSIG) + SUM(ECAD.SAI_EST_CONSIG)) SOMA,((SUM(ECAD.EST_ATU_MES) - SUM(ECAD.ENT_EST_CONSIG) + SUM(ECAD.SAI_EST_CONSIG)) * ECUS.CUSTO_MED) TOTAL
FROM ESHISCAD ECAD LEFT JOIN FAPRDCAD PRD ON PRD.CODIGO=ECAD.COD_PRD LEFT JOIN FATIPCAD TIP ON TIP.TIPO_PRD=PRD.TIPO_PRD LEFT JOIN ESHISCUS ECUS ON ECUS.COD_PRD=ECAD.COD_PRD
WHERE ECUS.ANO_MES=(SELECT  
CASE WHEN('01/01/2017' = $COMPETENCE) THEN '201701'   WHEN('01/02/2017' = $COMPETENCE) THEN '201702'  WHEN('01/03/2017' = $COMPETENCE) THEN '201703'  WHEN('01/04/2017' = $COMPETENCE) THEN '201704'  WHEN('01/05/2017' = $COMPETENCE
) THEN '201705'  WHEN('01/06/2017' = $COMPETENCE) THEN '201706'  WHEN('01/07/2017' = $COMPETENCE) THEN '201707'  WHEN('01/08/2017' = $COMPETENCE) THEN '201708'  WHEN('01/09/2017' = $COMPETENCE) THEN '201709'  WHEN('01/10/2017' = $COMPETENCE) THEN '201710'  WHEN('01/11/2017' = $COMPETENCE) THEN '201711'  WHEN('01/12/2017' = $COMPETENCE) THEN '201712' END AS DATA_REF
FROM DUAL)AND TIP.TIPO_PRD NOT IN('OPM')
AND ECAD.ANO_MES=(SELECT  
CASE WHEN('01/01/2017' = $COMPETENCE) THEN '201701'   WHEN('01/02/2017' = $COMPETENCE) THEN '201702'  WHEN('01/03/2017' = $COMPETENCE) THEN '201703'  WHEN('01/04/2017' = $COMPETENCE) THEN '201704'  WHEN('01/05/2017' = $COMPETENCE
) THEN '201705'  WHEN('01/06/2017' = $COMPETENCE) THEN '201706'  WHEN('01/07/2017' = $COMPETENCE) THEN '201707'  WHEN('01/08/2017' = $COMPETENCE) THEN '201708'  WHEN('01/09/2017' = $COMPETENCE) THEN '201709'  WHEN('01/10/2017' = $COMPETENCE) THEN '201710'  WHEN('01/11/2017' = $COMPETENCE) THEN '201711'  WHEN('01/12/2017' = $COMPETENCE) THEN '201712' END AS DATA_REF
FROM DUAL) GROUP BY ECAD.COD_PRD, TIP.TIPO_PRD, TIP.DESCRICAO, ECUS.CUSTO_MED)GROUP BY TIPO_PRD, DESCRICAO))

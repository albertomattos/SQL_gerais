create table ticket_medio (cod_set varchar2(4), data_atual date, valor NUMBER(16,2), faturas NUMBER(4,0), ticket NUMBER(16,2),
media6 NUMBER(16,2), fatura6 NUMBER(4,0), ticket6 NUMBER(16,2));
--drop table ticket_medio
--grant ALL on ticket_medio to wpd; select * from ticket_medio where cod_set in ('9902') and data_atual >= '01/01/2015' order by 2
insert into ticket_medio (cod_set,data_atual,valor,faturas) values(
(SELECT fafatprd.cod_set FROM FAFATPRD,FAPRDCAD,FATIPCAD,FAPACCAD,
FAFATCAD,FASETCAD,FACONCAD,FAREMCAD,FAPRTCAD,FAPRGCAD,ESGCNCAD WHERE FAFATPRD.COD_PRD = FAPRDCAD.CODIGO
AND FAPRDCAD.TIPO_PRD = FATIPCAD.TIPO_PRD AND FAFATCAD.FATURA   = FAFATPRD.FATURA AND FAFATPRD.COD_PAC  = FAPACCAD.COD_PAC
AND FAFATCAD.COD_CON  = FACONCAD.COD_CON AND FAPACCAD.COD_PRT  = FAPRTCAD.COD_PRT AND FASETCAD.COD_SET  = FAFATPRD.COD_SET
AND FAPRDCAD.COD_GRU  = FAPRGCAD.COD_PRG(+) AND FAPRDCAD.COD_GCN  = ESGCNCAD.COD_GCN(+) AND FAFATCAD.REMESSA = FAREMCAD.REMESSA
AND FAREMCAD.DATA_EMISS >= :P  AND FAREMCAD.DATA_EMISS <= :P  AND FAFATPRD.TIPO_PGTO IN ('D','H','R')
AND FAFATPRD.COD_SET  IN ('0133','0130','0134','0104','0191','0453','0006','0132','0025','0125','0128','0047','0376','0289','0118','0026','0136','0124','0135','0395',
'0396','0397','0322','0295','0149','0290','0190','0296','0258','0382','0294','0343','0039','0291','0120','0305','0067')
AND FAPACCAD.TIP_ATEND IN ('L','M','I','P','S') AND FAPACCAD.TIPO_PAC IN ('I','E','U','A')
AND FAFATCAD.COD_UNI IN ('0001')
GROUP BY FAFATPRD.cod_set),
(SELECT distinct '01/'||to_char(FAREMCAD.DATA_EMISS,'MM')||'/'||to_char(FAREMCAD.DATA_EMISS,'YYYY') FROM FAFATPRD,FAPRDCAD,FATIPCAD,FAPACCAD,
FAFATCAD,FASETCAD,FACONCAD,FAREMCAD,FAPRTCAD,FAPRGCAD,ESGCNCAD WHERE FAFATPRD.COD_PRD = FAPRDCAD.CODIGO
AND FAPRDCAD.TIPO_PRD = FATIPCAD.TIPO_PRD AND FAFATCAD.FATURA   = FAFATPRD.FATURA AND FAFATPRD.COD_PAC  = FAPACCAD.COD_PAC
AND FAFATCAD.COD_CON  = FACONCAD.COD_CON AND FAPACCAD.COD_PRT  = FAPRTCAD.COD_PRT AND FASETCAD.COD_SET  = FAFATPRD.COD_SET
AND FAPRDCAD.COD_GRU  = FAPRGCAD.COD_PRG(+) AND FAPRDCAD.COD_GCN  = ESGCNCAD.COD_GCN(+) AND FAFATCAD.REMESSA = FAREMCAD.REMESSA
AND FAREMCAD.DATA_EMISS >= :P  AND FAREMCAD.DATA_EMISS <= :P  AND FAFATPRD.TIPO_PGTO IN ('D','H','R')
AND FAFATPRD.COD_SET  IN ('0133','0130','0134','0104','0191','0453','0006','0132','0025','0125','0128','0047','0376','0289','0118','0026','0136','0124','0135','0395',
'0396','0397','0322','0295','0149','0290','0190','0296','0258','0382','0294','0343','0039','0291','0120','0305','0067')
AND FAPACCAD.TIP_ATEND IN ('L','M','I','P','S') AND FAPACCAD.TIPO_PAC IN ('I','E','U','A')
AND FAFATCAD.COD_UNI IN ('0001')
GROUP BY FAREMCAD.DATA_EMISS),
(SELECT SUM(SUM(FAFATPRD.VALOR_TOT)+SUM(FAFATPRD.VALOR_TAXA)) valor FROM FAFATPRD,FAPRDCAD,FATIPCAD,FAPACCAD,
FAFATCAD,FASETCAD,FACONCAD,FAREMCAD,FAPRTCAD,FAPRGCAD,ESGCNCAD WHERE FAFATPRD.COD_PRD = FAPRDCAD.CODIGO
AND FAPRDCAD.TIPO_PRD = FATIPCAD.TIPO_PRD AND FAFATCAD.FATURA   = FAFATPRD.FATURA AND FAFATPRD.COD_PAC  = FAPACCAD.COD_PAC
AND FAFATCAD.COD_CON  = FACONCAD.COD_CON AND FAPACCAD.COD_PRT  = FAPRTCAD.COD_PRT AND FASETCAD.COD_SET  = FAFATPRD.COD_SET
AND FAPRDCAD.COD_GRU  = FAPRGCAD.COD_PRG(+) AND FAPRDCAD.COD_GCN  = ESGCNCAD.COD_GCN(+) AND FAFATCAD.REMESSA = FAREMCAD.REMESSA
AND FAREMCAD.DATA_EMISS >= :P  AND FAREMCAD.DATA_EMISS <= :P  AND FAFATPRD.TIPO_PGTO IN ('D','H','R')
AND FAFATPRD.COD_SET  IN ('0133','0130','0134','0104','0191','0453','0006','0132','0025','0125','0128','0047','0376','0289','0118','0026','0136','0124','0135','0395',
'0396','0397','0322','0295','0149','0290','0190','0296','0258','0382','0294','0343','0039','0291','0120','0305','0067')
AND FAPACCAD.TIP_ATEND IN ('L','M','I','P','S') AND FAPACCAD.TIPO_PAC IN ('I','E','U','A')
AND FAFATCAD.COD_UNI IN ('0001')
GROUP BY FAFATPRD.FATURA)
,
(SELECT sum(count(distinct FAFATPRD.FATURA)) FROM FAFATPRD,FAPRDCAD,FATIPCAD,FAPACCAD,FAFATCAD,FASETCAD,FACONCAD,FAREMCAD,FAPRTCAD,FAPRGCAD,ESGCNCAD
WHERE FAFATPRD.COD_PRD  = FAPRDCAD.CODIGO AND FAPRDCAD.TIPO_PRD = FATIPCAD.TIPO_PRD AND FAFATCAD.FATURA   = FAFATPRD.FATURA
AND FAFATPRD.COD_PAC  = FAPACCAD.COD_PAC AND FAFATCAD.COD_CON  = FACONCAD.COD_CON AND FAPACCAD.COD_PRT  = FAPRTCAD.COD_PRT
AND FASETCAD.COD_SET  = FAFATPRD.COD_SET AND FAPRDCAD.COD_GRU  = FAPRGCAD.COD_PRG(+) AND FAPRDCAD.COD_GCN  = ESGCNCAD.COD_GCN(+)
AND FAFATCAD.REMESSA = FAREMCAD.REMESSA  AND FAREMCAD.DATA_EMISS >= :P  AND FAREMCAD.DATA_EMISS <= :P
AND FAFATPRD.TIPO_PGTO IN ('D','H','R') AND FAFATPRD.COD_SET  IN ('0133','0130','0134','0104','0191','0453','0006','0132','0025','0125','0128','0047','0376','0289','0118','0026','0136','0124','0135','0395',
'0396','0397','0322','0295','0149','0290','0190','0296','0258','0382','0294','0343','0039','0291','0120','0305','0067')
AND FAPACCAD.TIP_ATEND IN ('L','M','I','P','S')
AND FAPACCAD.TIPO_PAC IN ('I','E','U','A') AND FAFATCAD.COD_UNI IN ('0001') GROUP BY FAFATPRD.FATURA)
)
update ticket_medio set ticket = valor/faturas
